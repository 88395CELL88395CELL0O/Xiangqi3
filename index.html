    <!DOCTYPE html>
    <html lang="zh-TW">
    <head>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>é›…ç²å°ˆæ¥­è±¡æ£‹ - ç²¾æº–ä¿®æ­£ç‰ˆ</title>
        <style>
            body { background: #1a1a1a; color: white; text-align: center; font-family: "KaiTi", serif; margin: 0; overflow: hidden; }
            #game-container { display: none; flex-direction: column; align-items: center; justify-content: flex-start; height: 100vh; padding-top: 1px; position: relative; }
            #fx-overlay { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 1000; font-size: 80px; font-weight: bold; text-shadow: 0 0 30px black; display: none; color: #ff5722; }
            #end-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
            /* åŸºç¤çµæ§‹ï¼šæ§åˆ¶å¤§å°èˆ‡å½¢ç‹€ */
            
            @keyframes flip-shake {
        0% { transform: scale(1) rotate(0deg); }
        50% { transform: scale(1.4) rotate(180deg); filter: brightness(1.5); }
        100% { transform: scale(1) rotate(360deg); }
    }
    
    /* è®“æ£‹å­ç¿»è½‰è®Šå¤§çš„å‹•ç•« */
    @keyframes flip-eat {
        0% { transform: scale(1) rotate(0deg); }
        50% { transform: scale(1.6) rotate(180deg); filter: brightness(1.5); }
        100% { transform: scale(1) rotate(360deg); }
    }
    
    /* ç•¶ç¨‹å¼ç¢¼åµæ¸¬åˆ°åƒå­æ™‚ï¼Œæœƒå¹«æ ¼å­åŠ ä¸Šé€™å€‹é¡åˆ¥ */
    .eat-animation {
        animation: flip-eat 0.6s ease-in-out;
        z-index: 1000 !important; /* ç¢ºä¿è½‰å‹•æ™‚ä¸æœƒè¢«éš”å£æ ¼å­é®ä½ */
        position: relative;
    }
    
    .eat-effect {
        animation: flip-shake 0.6s ease-in-out;
        z-index: 999;
    }
    .timer {
        padding: 5px 2px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        text-align: center;
        min-width: 80px;
        
    }
    
    /* ä¸Šæ–¹æ™‚é˜ï¼šæ·±è—è‰² (å°æ‰‹) */
    #timer-top {
        background: #0D47A1;      /* æ·±è—åº•è‰² */
        color: #FFFFFF;           /* ç™½è‰²æ–‡å­— */
        border: 2px solid #1976D2; /* è—è‰²é‚Šæ¡† */
    }
    
    /* ä¸‹æ–¹æ™‚é˜ï¼šæ·±ç´…è‰² (æˆ‘æ–¹) */
    #timer-bottom {
        background: #B71C1C;      /* æ·±ç´…åº•è‰² */
        color: #FFFFFF;           /* ç™½è‰²æ–‡å­— */
        border: 2px solid #E53935; /* ç´…è‰²é‚Šæ¡† */
    }
    
    /* ç•¶è¼ªåˆ°æŸäººæ™‚ï¼Œæœƒè¦†è“‹åŸæœ¬é¡è‰²è®Šæˆäº®æ©˜è‰²ï¼Œæé†’æ†¶å«»è©²å‹•æ‰‹äº† */
    .timer.active {
        background-color: #FF9800 !important; 
        color: #000000 !important;
        box-shadow: 0 0 15px #FF9800;
        border: 2px solid #FFFFFF !important;
    }
    
    /* ç‰¹åˆ¥æ³¨æ„ï¼šè¦æŠŠä½ åŸæœ¬ JavaScript è£¡ç”¢ç”Ÿ connInfo çš„é‚£æ®µä»£ç¢¼åˆªæ‰ */
            canvas { background: #eec170; border: 5px solid #5d3410; touch-action: none; cursor: pointer; }
            button { padding: 10px 20px; font-size: 9px; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid white; color: white; background: #607d8b; }
            #edit-panel { display: none; background: #333; padding: 10px; border-radius: 10px; margin-top: 5px; width: 95%; max-width: 600px; }
            .login-box { background: #333; padding: 30px; border-radius: 20px; border: 2px solid #555; }
        </style>
    </head>
    <body>
    
    <div id="fx-overlay"></div>
    <div id="end-screen">
        <h1 id="result-text" style="font-size: 60px; color: #ffeb3b;"></h1>
        <button onclick="location.reload()" style="background: #4caf50; font-size: 30px;">é‡æ–°é–‹å§‹æ–°å±€</button>
    </div>
    
    <div id="login-screen" style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 class="bouncing-title">â¤ï¸ é›…ç²å°ˆæ¥­è±¡æ£‹ â¤ï¸</h1>
    
    <style>
        .bouncing-title {
            color: #ff69b4;
            font-size: 40px;
            text-shadow: 0 0 10px rgba(255, 105, 180, 0.8);
            animation: bounce 1.5s infinite ease-in-out; /* é€™è£¡æ§åˆ¶è·³å‹• */
            display: inline-block;
        }
    
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0) scale(1);
                text-shadow: 0 0 10px rgba(255, 105, 180, 0.8);
            }
            50% {
                transform: translateY(-20px) scale(1.1); /* å‘ä¸Šè·³ 20 åƒç´ ä¸¦ç¨å¾®æ”¾å¤§ */
                text-shadow: 0 0 30px rgba(255, 105, 180, 1); /* è·³èµ·æ™‚å…‰èŠ’æ›´äº® */
                color: #ff1493;
            }
        }
    </style>
        <div class="login-box">
            <input type="password" id="pwd-input" placeholder="å¯†ç¢¼ = ç”Ÿæ—¥" style="padding:10px; font-size:18px; text-align:center;"><br><br>
            <label>æ™‚é–“é™åˆ¶ï¼š</label>
            <select id="time-select" style="padding:5px; font-size:18px;">
                <option value="1">1 åˆ†é˜</option>
                <option value="10">10 åˆ†é˜</option>
                <option value="30">30 åˆ†é˜</option>
                <option value="999">ä¸é™æ™‚</option>
            </select><br><br>
            <button onclick="selectRole('R')" style="background:#d32f2f; margin-right:10px;">é¸ç´…æ–¹</button>
            <button onclick="selectRole('B')" style="background:#333;">é¸é»‘æ–¹</button>
        </div>
    </div>
    
     
    
    
    <div id="game-container">
        <div style="display:flex; justify-content: space-between; align-items: center; width: 95%; max-width: 500px; margin: 5px auto; gap: 5px;">
            
            <div style="flex: 2; text-align: left; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px;">
                <div style="font-size: 12px; color: #ffeb3b;">
                    æˆ‘çš„ ID: <b id="display-id">è®€å–ä¸­...</b>
                </div>
                <div id="conn-status" style="font-size: 10px; color: #00ff00; height: 12px;"></div>
                
                <div style="display: flex; gap: 2px; margin-top: 2px;">
                    <input type="text" id="friend-id" placeholder="è²¼ä¸ŠID" style="width: 70px; font-size: 11px;">
                    <button onclick="connectToFriend()" style="padding: 2px 5px; font-size: 11px; background: #4caf50;">é€£ç·š</button>
                </div>
            </div>
    
            <div id="timer-top" class="timer" style="flex: 1; min-width: 80px;">
                <div style="font-size: 10px;">å°æ‰‹</div>
                <div id="time-top-txt">--:--</div>
            </div>
    
            <div id="timer-bottom" class="timer" style="flex: 1; min-width: 80px;">
                <div style="font-size: 10px;">æˆ‘æ–¹</div>
                <div id="time-bottom-txt">--:--</div>
            </div>
        </div>
    
        <canvas id="chessBoard"></canvas><div class="controls" style="margin-top:1px; display:flex; gap:5px;">
        <button id="edit-btn" onclick="toggleEditMode()" 
                style="background:#9c27b0; padding: 1px 8px; font-size: 13px; border-radius: 4px;">ğŸ”§ æ“ºè¨­</button>
        <button onclick="resign()" 
                style="background:#d32f2f; padding: 1px 8px; font-size: 13px; border-radius: 4px;">ğŸ³ï¸ èªè¼¸</button>
                <button onclick="offerDraw()"
            style="background:#f57c00; padding: 1px 8px; font-size: 13px; border-radius: 4px;">ğŸ¤ å’Œæ£‹</button>
    </div>
    
    <div id="edit-panel" style="margin-top: 5px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 6px;">
        <select id="piece-select" style="padding:2px; font-size: 13px;">
            <optgroup label="ç´…æ–¹"><option value="K">å¸¥</option><option value="R">è»Š</option><option value="C">ç‚®</option><option value="N">é¦¬</option><option value="B">ç›¸</option><option value="A">ä»•</option><option value="P">å…µ</option></optgroup>
            <optgroup label="é»‘æ–¹"><option value="k">å°‡</option><option value="r">è»Š</option><option value="c">ç‚®</option><option value="n">é¦¬</option><option value="b">è±¡</option><option value="a">å£«</option><option value="p">å’</option></optgroup>
            <option value="delete">âŒ åˆªé™¤</option>
        </select>
        <button onclick="classicBoard()" style="background:#4caf50; padding: 3px 6px; font-size: 12px;">é‚„åŸ</button>
        <button onclick="clearBoard()" style="background:#f44336; padding: 3px 6px; font-size: 12px;">æ¸…ç©º</button>
    </div>
    
    
    <div id="chat-box" style="width: 95%; max-width: 500px; background: rgba(0,0,0,0.5); border-radius: 8px; margin-top: 1px; display: flex; flex-direction: column; overflow: hidden;">
        <div id="chat-messages" style="height: 60px; overflow-y: auto; text-align: left; padding: 5px; font-size: 14px; border-bottom: 1px solid #444; color: #fff;">
            </div>
        
        <div id="chat-controls" style="display: flex;">
            <input type="text" id="chat-input" placeholder="æˆåŠŸé€£ç·šå°±å¯ä»¥èŠå¤©å’Œæ‰“å±å±ğŸ˜‚" 
                   style="flex: 1; padding: 10px; border: none; background: #222; color: white; outline: none;">
            <button onclick="sendChatMessage()" 
                    style="background: #4caf50; border: none; padding: 1px 20px; color: white; cursor: pointer; font-weight: bold;">
                å‚³é€
            </button>
        </div>
    </div>
        
    
    <script>
        // --- 1. éŠæˆ²æ ¸å¿ƒè®Šæ•¸ ---
        const canvas = document.getElementById('chessBoard'), ctx = canvas.getContext('2d');
        const fx = document.getElementById('fx-overlay');
        let gridSize, mode = 'play', selected = null, turn = 'R', gameOver = false, myRole = 'R';
        let timeLeft = { R: 600, B: 600 }, timerInterval = null;
        const pieceText = { 'r':'è»Š','n':'é¦¬','b':'è±¡','a':'å£«','k':'å°‡','c':'ç‚®','p':'å’','R':'è»Š','N':'é¦¬','B':'ç›¸','A':'ä»•','K':'å¸¥','C':'ç‚®','P':'å…µ' };
        let board = [];
    
        // --- 2. éŸ³æ•ˆ ---
        const aCtx = new (window.AudioContext||window.webkitAudioContext)();
      function playSound(type) {
        if(aCtx.state==='suspended') aCtx.resume();
        const o = aCtx.createOscillator(), g = aCtx.createGain(), now = aCtx.currentTime;
        o.connect(g); g.connect(aCtx.destination);
        
        if(type==='move'){ o.frequency.setValueAtTime(300, now); g.gain.setValueAtTime(0.3, now); o.start(); o.stop(now+0.05); }
        if(type==='cap'){ o.type='square'; o.frequency.setValueAtTime(150, now); g.gain.setValueAtTime(0.0, now); o.start(); o.stop(now+0.1); }
        if(type==='check'){ [600, 400].forEach((f, i) => { const o2=aCtx.createOscillator(); o2.connect(g); o2.frequency.setValueAtTime(f, now+i*0.1); o2.start(now+i*0.1); o2.stop(now+i*0.1+0.1); }); }
        
        // --- æ–°å¢ï¼šå°ˆå±¬çµæŸéŸ³æ¨‚ ---
        if(type==='victory'){ 
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C-E-G-C é«˜éŸ³å’Œå¼¦
            notes.forEach((f, i) => { 
                const o2 = aCtx.createOscillator();
                const g2 = aCtx.createGain();
                o2.connect(g2);
                g2.connect(aCtx.destination);
                o2.type = 'triangle'; // ä½¿ç”¨è¼ƒæŸ”å’Œçš„ä¸‰è§’å½¢æ³¢
                o2.frequency.setValueAtTime(f, now + i * 0.1); 
                g2.gain.setValueAtTime(0.9, now + i * 0.1);
                g2.gain.exponentialRampToValueAtTime(0.0001, now + i * 0.1 + 0.8);
                o2.start(now + i * 0.1);
                o2.stop(now + i * 0.1 + 0.8); 
            }); 
        }
    }
    
        // --- 3. ç™»å…¥èˆ‡åˆå§‹åŒ– ---
        function selectRole(role) {
            if(document.getElementById('pwd-input').value !== '0129') return alert("å¯†ç¢¼éŒ¯èª¤");
            myRole = role;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            let setTime = parseInt(document.getElementById('time-select').value) * 60;
            timeLeft.R = timeLeft.B = setTime;
            classicBoard(); initCanvas(); startTimer();
        }
    
        function initCanvas() {
            let w = window.innerWidth * 0.95, h = window.innerHeight * 0.65;
            gridSize = Math.min(w/9, h/10);
            canvas.width = gridSize * 9; canvas.height = gridSize * 10;
            draw();
        }
    
        function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#5d3410'; ctx.lineWidth = 2;
        const off = gridSize/2;
    
        // --- (é€™æ®µç•«ç·šæ¢çš„ç¨‹å¼ç¢¼ä¸ç”¨å‹•ï¼Œä¿æŒåŸæ¨£) ---
        for(let j=0; j<10; j++) { ctx.beginPath(); ctx.moveTo(off, j*gridSize+off); ctx.lineTo(8*gridSize+off, j*gridSize+off); ctx.stroke(); }
        for(let i=0; i<9; i++) { ctx.beginPath(); if(i===0 || i===8) { ctx.moveTo(i*gridSize+off, off); ctx.lineTo(i*gridSize+off, 9*gridSize+off); } else { ctx.moveTo(i*gridSize+off, off); ctx.lineTo(i*gridSize+off, 4*gridSize+off); ctx.moveTo(i*gridSize+off, 5*gridSize+off); ctx.lineTo(i*gridSize+off, 9*gridSize+off); } ctx.stroke(); }
        const drawX = (yS, yE) => { ctx.beginPath(); ctx.moveTo(3*gridSize+off, yS*gridSize+off); ctx.lineTo(5*gridSize+off, yE*gridSize+off); ctx.stroke(); ctx.beginPath(); ctx.moveTo(5*gridSize+off, yS*gridSize+off); ctx.lineTo(3*gridSize+off, yE*gridSize+off); ctx.stroke(); };
        drawX(0, 2); drawX(7, 9);
        const drawMarker = (x, y) => { const g = gridSize*0.1, l = gridSize*0.2, cx = x*gridSize+off, cy = y*gridSize+off; [[-1,-1], [1,-1], [-1,1], [1,1]].forEach(p => { if ((p[0]===-1 && x>0) || (p[0]===1 && x<8)) { ctx.beginPath(); ctx.moveTo(cx+p[0]*g, cy+p[1]*g); ctx.lineTo(cx+p[0]*(g+l), cy+p[1]*g); ctx.stroke(); ctx.beginPath(); ctx.moveTo(cx+p[0]*g, cy+p[1]*g); ctx.lineTo(cx+p[0]*g, cy+p[1]*(g+l)); ctx.stroke(); } }); };
        [1, 7].forEach(x => [2, 7].forEach(y => drawMarker(x, y)));
        [0, 2, 4, 6, 8].forEach(x => [3, 6].forEach(y => drawMarker(x, y)));
        ctx.fillStyle = '#5d3410'; ctx.font = `bold ${gridSize*0.5}px "KaiTi"`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText("æ“ æŠ±  å¤ª é™½", 2*gridSize+off, 4.5*gridSize+off); ctx.fillText("é›… ç²  å§ å§", 6*gridSize+off, 4.5*gridSize+off);
    
        // --- ç•«æ£‹å­ (é€™è£¡æ˜¯è¢«å¤§å¹…ä¿®æ”¹çš„é‡é») ---
        for(let ly=0; ly<10; ly++) for(let lx=0; lx<9; lx++) {
            let p = board[ly][lx]; if(p === '.') continue;
            
            let dx = (myRole === 'B') ? 8 - lx : lx;
            let dy = (myRole === 'B') ? 9 - ly : ly;
            let cx = dx*gridSize+off;
            let cy = dy*gridSize+off;
            let isR = (p === p.toUpperCase());
    
            // 1. ä¿å­˜ç¾åœ¨çš„ç•«ç­†ç‹€æ…‹
            ctx.save();
            
            // 2. ç§»å‹•ç•«å¸ƒä¸­å¿ƒé»åˆ°é€™é¡†æ£‹å­çš„ä½ç½®
            ctx.translate(cx, cy);
    
            // 3. å¦‚æœé€™é¡†æ£‹å­æ­£åœ¨å‹•ç•«ä¸­ï¼Œå°±å°å®ƒé€²è¡Œç¸®æ”¾å’Œæ—‹è½‰
            if (animatingPiece && animatingPiece.lx === lx && animatingPiece.ly === ly) {
                let s = animatingPiece.scale; 
                let r = animatingPiece.rotate;
                ctx.scale(s, s);     // è®Šå¤§
                ctx.rotate(r);       // æ—‹è½‰
            }
    
            // 4. ç•«åœ“å’Œå­— (æ³¨æ„ï¼šå› ç‚ºå·²ç¶“ translateï¼Œæ‰€ä»¥åœ“å¿ƒåº§æ¨™è®Šæˆ 0,0)
            ctx.beginPath(); 
            ctx.arc(0, 0, gridSize*0.43, 0, Math.PI*2); 
            ctx.fillStyle = '#f9dfbc'; ctx.fill();
            ctx.strokeStyle = isR ? '#d00' : '#000'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = isR ? '#d00' : '#000'; 
            ctx.font = `bold ${gridSize*0.55}px "KaiTi"`; 
            ctx.fillText(pieceText[p], 0, gridSize*0.05);
    
            // 5. æ¢å¾©ç•«ç­†ç‹€æ…‹ (é¿å…å½±éŸ¿ä¸‹ä¸€é¡†æ£‹å­)
            ctx.restore();
    
            // ç•«é¸å–æ¡†
            if(selected && selected.lx===lx && selected.ly===ly) { 
                ctx.strokeStyle='#00f'; ctx.lineWidth=4; 
                ctx.strokeRect(cx-gridSize*0.48, cy-gridSize*0.48, gridSize*0.96, gridSize*0.96); 
            }
        }
    }
    
        // --- 4. ç§»å‹•è¦å‰‡èˆ‡å¹¾ä½•åˆ¤å®š ---
        function canMoveGeom(p, x1, y1, x2, y2, b) {
            let dx = Math.abs(x2-x1), dy = Math.abs(y2-y1), type = p.toLowerCase(), target = b[y2][x2];
            if(target !== '.' && (target === target.toUpperCase()) === (p === p.toUpperCase())) return false;
            const cnt = (x1,y1,x2,y2,b) => {
                let c=0; if(x1===x2) for(let i=Math.min(y1,y2)+1; i<Math.max(y1,y2); i++) { if(b[i][x1]!=='.') c++; }
                else for(let i=Math.min(x1,x2)+1; i<Math.max(x1,x2); i++) { if(b[y1][i]!=='.') c++; } return c;
            };
            switch(type) {
                case 'r': return (x1===x2 || y1===y2) && cnt(x1,y1,x2,y2,b)===0;
                case 'c': if(x1!==x2 && y1!==y2) return false; let c = cnt(x1,y1,x2,y2,b); return target==='.' ? c===0 : c===1;
                case 'n': return ((dx===1&&dy===2)||(dx===2&&dy===1)) && b[dy===2?y1+(y2-y1)/2:y1][dx===2?x1+(x2-x1)/2:x1]==='.';
                case 'b': return dx===2&&dy===2&&(p==='B'?y2>=5:y2<=4) && b[(y1+y2)/2][(x1+x2)/2]==='.';
                case 'a': return dx===1&&dy===1&&x2>=3&&x2<=5&&(p==='A'?y2>=7:y2<=9)&&(p==='a'?y2<=2:true);
                case 'k': if(dx+dy===1 && x2>=3 && x2<=5 && (p==='K'?y2>=7:y2<=9) && (p==='k'?y2<=2:true)) return true;
                           return (x1===x2 && target.toLowerCase()==='k' && cnt(x1,y1,x2,y2,b)===0);
                case 'p': if(dx+dy!==1) return false;
                          if(p==='P') return y2<=y1 && (y1>=5 ? x1===x2 : true);
                          return y2>=y1 && (y1<=4 ? x1===x2 : true);
            }
            return false;
        }
    
        // --- 5. å®‰å…¨æª¢æŸ¥ (ä¿®æ­£é˜²å‘†) ---
        function isKingSafe(color, b) {
            let kPos = null, myKing = (color==='R'?'K':'k');
            for(let y=0; y<10; y++) for(let x=0; x<9; x++) if(b[y][x]===myKing) { kPos={x,y}; break; }
            if(!kPos) return false; // æ‰¾ä¸åˆ°å°‡å¸¥ï¼Œç›´æ¥è¦–ç‚ºä¸å®‰å…¨
            for(let y=0; y<10; y++) for(let x=0; x<9; x++) {
                let p = b[y][x]; if(p!=='.' && (p===p.toUpperCase())!==(color==='R')) 
                    if(canMoveGeom(p, x, y, kPos.x, kPos.y, b)) return false;
            }
            return true;
        }
    
      // --- 6. é»æ“Šäº‹ä»¶ (ä¿®æ­£ç‰ˆï¼šæ”¯æ´æ“ºè­œæ¨¡å¼ç§»å‹•) ---
    canvas.addEventListener('mousedown', e => {
        if (gameOver) return;
        const rect = canvas.getBoundingClientRect();
        let vx = Math.floor((e.clientX - rect.left) / gridSize);
        let vy = Math.floor((e.clientY - rect.top) / gridSize);
        
        let lx = (myRole === 'B') ? 8 - vx : vx;
        let ly = (myRole === 'B') ? 9 - vy : vy;
    
        if (lx < 0 || lx > 8 || ly < 0 || ly > 9) return;
    
        // --- æ–°å¢ï¼šæ“ºè­œæ¨¡å¼çš„é‚è¼¯ ---
        if (mode === 'edit') {
            let t = document.getElementById('piece-select').value;
            if (t === 'delete') {
                board[ly][lx] = '.';
            } else {
                board[ly][lx] = t;
            }
            draw();
            return; // æ“ºè­œæ¨¡å¼åˆ°æ­¤çµæŸï¼Œä¸åŸ·è¡Œä¸‹æ–¹çš„éŠæˆ²è¦å‰‡æª¢æŸ¥
        }
    
        // --- ä»¥ä¸‹ç‚ºæ­£å¸¸å°æˆ°æ¨¡å¼çš„é‚è¼¯ ---
        if (selected) {
            let p = selected.p;
            let oldTarget = board[ly][lx];
    
            if (canMoveGeom(p, selected.lx, selected.ly, lx, ly, board)) {
                // æ¨¡æ“¬ç§»å‹•æª¢æŸ¥å®‰å…¨æ€§
                board[ly][lx] = p;
                board[selected.ly][selected.lx] = '.';
                let safe = isKingSafe(turn, board);
                
                // é‚„åŸç‹€æ…‹äº¤ç”± executeMove æ­£å¼è™•ç†
                board[selected.ly][selected.lx] = p;
                board[ly][lx] = oldTarget;
    
                if (safe) {
                    if (globalConn && globalConn.open) {
                        globalConn.send({ 
                            type: 'move', 
                            move: [selected.lx, selected.ly, lx, ly], 
                            time: timeLeft 
                        });
                    }
                    executeMove(selected.lx, selected.ly, lx, ly);
                    selected = null;
                } else {
                    alert("ä¸è¡Œï¼é€™æ¨£æœƒè¢«å°‡è»å–”ï¼ğŸ˜±");
                    selected = null;
                    draw();
                }
            } else {
                // åˆ‡æ›é¸å–æ£‹å­
                let targetP = board[ly][lx];
                if (targetP !== '.' && (targetP === targetP.toUpperCase()) === (turn === 'R') && turn === myRole) {
                    selected = { lx, ly, p: targetP };
                    draw();
                } else {
                    selected = null;
                    draw();
                }
            }
        } else {
            // é¸å–æ£‹å­
            let p = board[ly][lx];
            if (p !== '.' && (p === p.toUpperCase()) === (turn === 'R') && turn === myRole) {
                selected = { lx, ly, p };
                draw();
            }
        }
    });
        // --- 7. éŠæˆ²ç‹€æ…‹æª¢æŸ¥ (ä¿®æ­£å‹è² åˆ¤å®š) ---
        function checkGameState() {
            let inCheck = !isKingSafe(turn, board);
            if(inCheck) { fx.innerText="å°‡ è»"; fx.style.display='block'; setTimeout(()=>fx.style.display='none',1000); playSound('check'); }
            
            let hasMove = false;
            for(let y1=0; y1<10; y1++) for(let x1=0; x1<9; x1++) {
                let p = board[y1][x1]; 
                if(p!=='.' && (p===p.toUpperCase())===(turn==='R')) {
                    for(let y2=0; y2<10; y2++) for(let x2=0; x2<9; x2++) {
                        if(canMoveGeom(p, x1, y1, x2, y2, board)) {
                            let old = board[y2][x2]; board[y2][x2]=p; board[y1][x1]='.';
                            let safe = isKingSafe(turn, board); board[y1][x1]=p; board[y2][x2]=old;
                            if(safe) { hasMove=true; break; }
                        }
                    }
                }
                if(hasMove) break;
            }
            if(!hasMove) endGame(inCheck ? "å°‡ æ®º" : "å›° æ–ƒ");
        }
    
        // --- 8. çµæŸéŠæˆ² (ä¿®æ­£åƒæ•¸) ---
        function endGame(r, forceWinner) { 
        // ç„¡è«–ä»€éº¼å½¢å¼çµæŸï¼Œå…ˆæ”¾éŸ³æ¨‚
        playSound('victory'); 
    
        gameOver = true; 
        clearInterval(timerInterval); 
        
        let winner = forceWinner ? forceWinner : (turn === 'R' ? "é»‘æ–¹å‹" : "ç´…æ–¹å‹");
        document.getElementById('result-text').innerText = r + "ï¼" + winner; 
        document.getElementById('end-screen').style.display = 'flex'; 
    }
    
        // --- 9. è¼”åŠ©åŠŸèƒ½ ---
        function classicBoard() { board=[['r','n','b','a','k','a','b','n','r'],['.','.','.','.','.','.','.','.','.'],['.','c','.','.','.','.','.','c','.'],['p','.','p','.','p','.','p','.','p'],['.','.','.','.','.','.','.','.','.'],['.','.','.','.','.','.','.','.','.'],['P','.','P','.','P','.','P','.','P'],['.','C','.','.','.','.','.','C','.'],['.','.','.','.','.','.','.','.','.'],['R','N','B','A','K','A','B','N','R']]; draw(); }
        function clearBoard() { board=Array(10).fill().map(()=>Array(9).fill('.')); draw(); }
        function startTimer() { timerInterval=setInterval(()=>{ if(!gameOver && mode==='play' && timeLeft[turn]>0) { timeLeft[turn]--; updateTimerUI(); if(timeLeft[turn]<=0) endGame("è¶…æ™‚"); } },1000); }
        function updateTimerUI() {
            document.getElementById('timer-bottom').className = (turn === myRole) ? 'timer active' : 'timer';
            document.getElementById('timer-top').className = (turn !== myRole) ? 'timer active' : 'timer';
            const fmt = (s) => (s > 3600) ? "âˆ" : Math.floor(s/60) + ":" + (s%60).toString().padStart(2,'0');
            document.getElementById('time-bottom-txt').innerText = fmt(timeLeft[myRole]);
            let opp = (myRole==='R'?'B':'R'); document.getElementById('time-top-txt').innerText = fmt(timeLeft[opp]);
        }
        
        // --- 10. æŒ‰éˆ•åŠŸèƒ½ (ä¿®æ­£ç·¨è¼¯æ¨¡å¼) ---
        function toggleEditMode() { 
            mode = (mode === 'play' ? 'edit' : 'play'); 
            document.getElementById('edit-panel').style.display = (mode === 'edit' ? 'block' : 'none'); 
            document.getElementById('edit-btn').innerText = (mode === 'edit' ? 'âœ… å®Œæˆæ“ºè­œ' : 'ğŸ”§ æ“ºè¨­æ£‹è­œ'); 
            selected = null; 
            if (mode === 'play') {
                if (globalConn && globalConn.open) globalConn.send({ type: 'syncBoard', board: board });
                checkGameState(); // æ“ºå®Œé¦¬ä¸Šæª¢æŸ¥æ­»æ£‹
                draw();
            }
        }
        function resign() { 
            if(globalConn && globalConn.open) globalConn.send({ type: 'resign', reason: "å°æ‰‹èªè¼¸" });
            // æˆ‘èªè¼¸ = å°æ‰‹è´
            let winner = (myRole === 'R' ? "é»‘æ–¹å‹" : "ç´…æ–¹å‹");
            endGame("èª è¼¸", winner); 
        }
        window.addEventListener('resize', initCanvas);
    
    function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;
    
        // 1. é¡¯ç¤ºåœ¨è‡ªå·±çš„ç•«é¢ä¸Š
        appendMessage("æˆ‘", msg, "#4caf50");
    
        // 2. é€éé€£ç·šç™¼é€çµ¦å°æ–¹
        if (globalConn && globalConn.open) {
            globalConn.send({ type: 'chat', msg: msg });
        }
        
        input.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
    }
    
    // è¼”åŠ©å‡½æ•¸ï¼šå°‡æ–‡å­—æ¸²æŸ“åˆ°èŠå¤©è¦–çª—
    function appendMessage(sender, text, color) {
        const container = document.getElementById('chat-messages');
        if(!container) return;
        const msgDiv = document.createElement('div');
        msgDiv.style.marginBottom = "4px";
        msgDiv.innerHTML = `<span style="color:${color}; font-weight:bold;">${sender}:</span> <span style="color:white;">${text}</span>`;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight; // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸‹é¢
    }
    </script>
    
    
    
    
    
    <script>
    
    // --- 11. é€£ç·šåŠŸèƒ½ (ç©©å®šé€šè¨Š & è‡ªå®šç¾©å°è©±æ¡†ç‰ˆ) ---
    
    // 1. åˆå§‹åŒ– 4 ç¢¼ ID (è‡ªå‹•ç”¢ç”Ÿï¼Œä¸è·³å½ˆçª—)
    var myShortId = Math.floor(1000 + Math.random() * 9000).toString();
    var peer = new Peer(myShortId); 
    var globalConn = null;
    var animatingPiece = null;
    
    // 2. ID é¡¯ç¤ºèˆ‡ç•«é¢æ§åˆ¶
    peer.on('open', function(id) {
        var idElem = document.getElementById('display-id');
        if (idElem) idElem.innerText = id;
        
        var loginScreen = document.getElementById('login-screen');
        if (loginScreen) {
            loginScreen.style.display = 'flex';
            loginScreen.style.zIndex = '9999'; 
        }
    });
    
    // 3. æ¥æ”¶é€£ç·š
    peer.on('connection', function(conn) {
        globalConn = conn;
        setupCommunication(); 
        updateStatus("ç‹€æ…‹ï¼šæœ‹å‹å·²é€£å…¥ï¼");
    });
    
    // 4. é€£æ¥æœ‹å‹
    function connectToFriend() {
        var fId = document.getElementById('friend-id').value.trim();
        if (!fId) return alert("è«‹è¼¸å…¥å°æ‰‹çš„ 4 ç¢¼ ID");
        globalConn = peer.connect(fId);
        setupCommunication();
        updateStatus("ç‹€æ…‹ï¼šå˜—è©¦é€£ç·šä¸­...");
    }
    
    // 5. æ ¸å¿ƒç›£è½ (æ”¹ç”¨è‡ªå®šç¾© UIï¼Œè§£æ±ºç§’æ‹’çµ•å•é¡Œ)
    function setupCommunication() {
        if (!globalConn) return;
    
        globalConn.on('open', function() {
            updateStatus("ç‹€æ…‹ï¼šé€£ç·šæˆåŠŸï¼");
        });
    
        globalConn.on('data', function(data) {
            console.log("æ”¶åˆ°æ•¸æ“š:", data);
            if (data.type === 'syncBoard') {
                board = data.board;
                draw();
                if (typeof checkGameState === "function") checkGameState();
            } 
            else if (data.type === 'move') {
                executeMove(data.move[0], data.move[1], data.move[2], data.move[3]);
            } 
            else if (data.type === 'chat') {
                appendMessage("å°æ‰‹", data.msg, "#ff9800"); 
            }
            else if (data.type === 'offerDraw') {
                showDrawUI(); // èª¿ç”¨è‡ªå®šç¾©æ±‚å’Œç•«é¢ï¼Œä¸ä½¿ç”¨ confirm()
            }
            else if (data.type === 'acceptDraw') {
                endGame("å°æ–¹åŒæ„æ±‚å’Œ", "å’Œå±€");
            }
            else if (data.type === 'declineDraw') {
                alert("å°æ–¹æ‹’çµ•äº†å’Œæ£‹æè­°ã€‚");
            }
            else if (data.type === 'resign') {
                endGame("å°æ‰‹èªè¼¸");
            }
        });
    }
    
    // 6. è‡ªå®šç¾©æ±‚å’Œå°è©±æ¡† (è§£æ±ºç§’æ‹’çµ•å•é¡Œçš„é—œéµ)
    function showDrawUI() {
        if (document.getElementById('custom-draw-box')) return;
        const box = document.createElement('div');
        box.id = "custom-draw-box";
        box.style = "position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#2c3e50; padding:30px; border:4px solid #f39c12; border-radius:20px; z-index:10000; text-align:center; box-shadow: 0 0 30px rgba(0,0,0,0.8); min-width:280px;";
        box.innerHTML = `
            <h2 style="color:#f1c40f; margin:0 0 20px 0; font-size:24px;">ğŸ¤ å’Œæ£‹æè­°</h2>
            <p style="color:white; font-size:18px; margin-bottom:25px;">å°æ–¹æè­°å’Œæ£‹ï¼Œä½ æ¥å—å—ï¼Ÿ</p>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button id="draw-yes" style="background:#27ae60; color:white; border:none; padding:12px 25px; border-radius:10px; font-size:18px; cursor:pointer; font-weight:bold;">åŒæ„</button>
                <button id="draw-no" style="background:#c0392b; color:white; border:none; padding:12px 25px; border-radius:10px; font-size:18px; cursor:pointer; font-weight:bold;">æ‹’çµ•</button>
            </div>
        `;
        document.body.appendChild(box);
    
        document.getElementById('draw-yes').onclick = () => {
            globalConn.send({ type: 'acceptDraw' });
            box.remove();
            endGame("é›™æ–¹å’Œæ£‹", "å’Œå±€");
        };
        document.getElementById('draw-no').onclick = () => {
            globalConn.send({ type: 'declineDraw' });
            box.remove();
        };
    }
    
    // 7. ä¿®å¾©å’Œæ£‹ç™¼é€
    function offerDraw() {
        if (globalConn && globalConn.open) {
            globalConn.send({ type: 'offerDraw' }); 
            updateStatus("ç‹€æ…‹ï¼šå·²é€å‡ºæ±‚å’Œè«‹æ±‚...");
        } else {
            alert("å°šæœªé€£ç·šï¼");
        }
    }
    
    // 8. ä¿®æ­£ç§»å‹•åŸ·è¡Œèˆ‡å°‡è»æª¢æŸ¥
    function executeMove(x1, y1, x2, y2) {
        if (!board || !board[y1]) return;
        var p = board[y1][x1], old = board[y2][x2], isCapture = (old !== '.');
        board[y2][x2] = p; board[y1][x1] = '.';
    
        if (isCapture) {
            playFunnySound();
            var start = null;
            function step(timestamp) {
                if (!start) start = timestamp;
                var progress = (timestamp - start) / 600;
                if (progress < 1) {
                    animatingPiece = { lx: x2, ly: y2, scale: 1 + Math.sin(progress * Math.PI) * 0.5, rotate: progress * Math.PI * 4 };
                    draw(); requestAnimationFrame(step);
                } else { animatingPiece = null; draw(); }
            }
            requestAnimationFrame(step);
        }
        
        turn = (turn === 'R' ? 'B' : 'R');
        if (typeof playSound === "function") playSound(isCapture ? 'cap' : 'move');
        
        // ç¢ºä¿å°‡è»åˆ¤å®šé‹ä½œ
        if (typeof checkGameState === "function") checkGameState();
        if (!isCapture) draw(); 
    }
    
    function updateStatus(msg) {
        var statusElem = document.getElementById('conn-status');
        if (statusElem) statusElem.innerText = msg;
    }
    
   function playFunnySound() {
    // 1. å°‡ç¶²å€æ›¿æ›æˆä½ çš„å®Œæ•´æª”æ¡ˆåç¨± (æ³¨æ„å‰¯æª”åå¿…é ˆæ˜¯ .mp3)
    var audio = new Audio('eat.mp3');
    
    // 2. éŸ³é‡å»ºè­°è¨­å®šç‚º 1.0 (æœ€å¤§å€¼)ï¼Œè¨­ç‚º 2 åœ¨æŸäº›ç€è¦½å™¨å¯èƒ½æœƒå¤±æ•ˆ
    audio.volume = 1.0; 
    
    // 3. åŸ·è¡Œæ’­æ”¾
    audio.play().catch(function(err){
        console.log("éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯å› ç‚ºæª”åéŒ¯èª¤æˆ–æª”æ¡ˆä¸åœ¨åŒä¸€å€‹è³‡æ–™å¤¾:", err);
    });
}
    </script>
    </body>
    </html>
